<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Internship Matches – internSarthi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-[#ECEDED] min-h-screen font-sans">

<nav class="sticky top-0 z-50 bg-white border-b border-gray-200 mb-6 shadow-sm">
  <div class="w-full px-8 py-3 flex justify-between items-center">
    <div class="text-2xl font-bold text-[#1F2A3A]">internSarthi</div>

    <div class="flex gap-4 text-sm items-center">
      <a href="recommend.html"
         class="text-gray-600 hover:text-black hover:opacity-90 active:scale-[0.98] transition">
        Internships
      </a>

      <a href="skill_gap.html"
         class="text-gray-600 hover:text-black hover:opacity-90 active:scale-[0.98] transition">
        Learning Path
      </a>

      <a href="dashboard.html"
         class="bg-[#1F2A3A] text-white px-4 py-2 rounded-xl text-sm
                hover:opacity-90 active:scale-[0.98] transition">
        Dashboard
      </a>
    </div>
  </div>
</nav>

  <!-- PAGE HEADER -->
<div class="max-w-6xl mx-auto px-4 mt-6 mb-6">
  <h1 class="text-2xl font-bold text-[#0F172A] tracking-tight">
    Internship Matches
  </h1>
  <p class="text-sm text-gray-500 mt-1">
    Personalized internship recommendations based on your profile
  </p>
</div>

<div class="max-w-6xl mx-auto px-4">
  <div class="h-px bg-gray-200"></div>
</div>


  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-sm p-8">


    <!-- HEADER -->
    <div class="mb-6">
      <h1 id="welcome" class="text-2xl font-bold text-[#0F172A] mb-1"></h1>
      <div class="flex justify-between items-center mb-6">
        <a href="skill_gap.html"
           class="bg-[#1F2A3A] text-white px-5 py-2 rounded-lg text-sm hover:opacity-90 active:scale-[0.98] transition">
          View Learning Path
        </a>

        <a href="dashboard.html"
           class="text-sm text-gray-600 underline hover:opacity-90 active:scale-[0.98] transition">
          Go to Dashboard
        </a>
      </div>

      <p class="text-sm text-gray-500">
        These internships are selected based on your role and skills.
      </p>
    </div>

    <!-- INFO CARD -->
    <div class="bg-[#1F2A3A] rounded-xl p-5 text-[#F9FAFB] mb-8">
      <p class="text-sm leading-relaxed">
        Each internship below shows the skills you already have and the skills
        you may need to learn. You don’t need to be perfect to start.
      </p>
    </div>

    <!-- RESULTS -->
    <div id="internshipList" class="space-y-6">
      <p class="text-sm text-gray-500">Loading internships...</p>
    </div>


  </div>

  <!-- SCRIPT -->
  <script>
  const name = localStorage.getItem("user_name") || "there";
  const roles = JSON.parse(localStorage.getItem("user_roles")) || [];

  if (!roles.length) {
    alert("No roles found. Please complete your profile again.");
    window.location.href = "profile.html";
  }

  // ORIGINAL skills (for display only if needed)
  const userSkillsOriginal =
    (localStorage.getItem("user_skills") || "")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);

  // LOWERCASE copy (ONLY for comparison / backend)
  const userSkillsLower =
    userSkillsOriginal.map(s => s.toLowerCase());


  document.getElementById("welcome").innerText =
    `Hi ${name}, here are the best internship matches for you`;

  async function fetchAllRecommendations() {
    let allResults = [];

    for (const role of roles) {
      try {
        const res = await fetch("http://127.0.0.1:8001/recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            role: role,
            user_skills: userSkillsLower
          })
        });

        const data = await res.json();

        data.forEach(item => {
          item.target_role = role;
          allResults.push(item);
        });

      } catch (err) {
        console.error("Failed to fetch for role:", role, err);
      }
    }

    return allResults;
  }

  function removeDuplicates(list) {
    const map = new Map();
    list.forEach(item => {
      const key = item.internship_title + item.company_name;
      if (!map.has(key)) {
        map.set(key, item);
      }
    });
    return Array.from(map.values());
  }

  function sortResults(list) {
    return list.sort((a, b) => {
      if (a.match_type === b.match_type) {
        return b.match_score - a.match_score;
      }
      return a.match_type === "primary" ? -1 : 1;
    });
  }


  const safe = str =>
    String(str || "").replace(/'/g, "&#39;");




  async function initRecommendations() {
    const container = document.getElementById("internshipList");
    container.innerHTML =
      "<p class='text-sm text-gray-500'>Loading internships...</p>";

    let results = await fetchAllRecommendations();
    results = removeDuplicates(results);
    results = sortResults(results);

    container.innerHTML = "";

    if (!results.length) {
      container.innerHTML =
        "<p class='text-sm text-gray-500'>No internships matched your current profile. Try adding more skills or roles.</p>";
      return;
    }

    results.forEach(item => {
      const title = safe(item.internship_title);
      const company = safe(item.company_name);
      const location = safe(item.location);
      const role = safe(item.target_role);

      const card = document.createElement("div");
      card.className =
        "bg-white border border-[#E5E7EB] rounded-xl p-6";

      card.innerHTML = `
        <span class="text-xs bg-[#1F2A3A]/10 text-[#1F2A3A]
                     px-2 py-1 rounded-full mb-2 inline-block">
          Role: ${role}
        </span>

        <h3 class="text-lg font-semibold text-[#0F172A]">
          ${title}
        </h3>

        <p class="text-sm text-gray-500 mb-2">
          ${company} • ${location}
        </p>

        <p class="text-sm mb-3">
          Match score: <b>${item.match_score}%</b>
        </p>

        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <p class="text-sm font-medium mb-1">You already know</p>
            <ul class="list-disc ml-6 text-sm text-gray-600">
              ${
                item.skills_you_have.length
                  ? item.skills_you_have.map(s => `<li>${s}</li>`).join("")
                  : "<li>No matching skills yet</li>"
              }
            </ul>
          </div>

          <div>
            <p class="text-sm font-medium mb-1">You can learn next</p>
            <ul class="list-disc ml-6 text-sm text-gray-600">
              ${
                item.skills_to_learn.length
                  ? item.skills_to_learn.map(s => `<li>${s}</li>`).join("")
                  : "<li>You are ready for this role</li>"
              }
            </ul>
          </div>
        </div>

        <div class="flex gap-3 mt-5">
          <button
            class="bg-[#1F2A3A] text-white px-4 py-2 rounded-lg text-sm hover:opacity-90 active:scale-[0.98] transition"
            onclick="applyInternship('${title}','${company}','${location}')">
            Apply
          </button>

          <button
            class="border border-gray-300 px-4 py-2 rounded-lg text-sm hover:opacity-90 active:scale-[0.98] transition"
            onclick="saveInternship('${title}','${company}','${location}')">
            Save
          </button>
        </div>
      `;

      container.appendChild(card);
});

  }

  function applyInternship(title, company, location) {
    let applied = JSON.parse(localStorage.getItem("applied_internships")) || [];

    const exists = applied.some(
      i => i.title === title && i.company === company
    );

    if (exists) {
      alert("You have already applied for this internship.");
      return;
    }

    applied.push({
      title,
      company,
      location,
    });

    localStorage.setItem(
      "applied_internships",
      JSON.stringify(applied)
    );

    alert("Internship marked as applied!");
  }




  function saveInternship(title, company, location) {
    let saved = JSON.parse(localStorage.getItem("saved_internships")) || [];

    const exists = saved.some(
      i => i.title === title && i.company === company
    );

    if (exists) {
      alert("This internship is already saved.");
      return;
    }

    saved.push({
      title,
      company,
      location,
    });

    localStorage.setItem(
      "saved_internships",
      JSON.stringify(saved)
    );

    alert("Internship saved successfully!");
  }





  initRecommendations();
</script>


</body>
</html>



